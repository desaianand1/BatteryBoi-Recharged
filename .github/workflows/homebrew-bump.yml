name: Bump Homebrew Cask

on:
  release:
    types: [published]

jobs:
  bump-cask:
    name: Bump Homebrew Cask
    runs-on: macos-15
    # Only run for stable releases (not prereleases or drafts)
    if: >-
      github.event.release.prerelease == false &&
      github.event.release.draft == false
    steps:
      - name: Validate Release Tag
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Release tag '$TAG' does not match expected format vX.Y.Z"
            exit 1
          fi
          echo "Valid release tag: $TAG"

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Bump Cask
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.HOMEBREW_GITHUB_API_TOKEN }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix

          echo "Bumping batteryboi-recharged to version $VERSION"

          brew bump-cask-pr \
            --version="$VERSION" \
            --no-browse \
            --message="Automated bump from release workflow" \
            batteryboi-recharged
