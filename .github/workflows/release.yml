name: Release

on:
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '16.2'
  NODE_VERSION: '24'
  SPARKLE_VERSION: '2.8.1'
  SCHEME: 'BatteryBoi - Recharged'
  PROJECT: 'BatteryBoi.xcodeproj'
  APP_NAME: 'BatteryBoi - Recharged'

jobs:
  build-release:
    name: Build Release
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - name: Extract version from tag
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Build, Sign, and Notarize
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: bundle exec fastlane release

      - name: Set DMG path
        run: |
          DMG_NAME="${{ env.APP_NAME }}-${{ env.VERSION }}.dmg"
          # Fastlane outputs to fastlane/build/ (relative to its working directory)
          echo "DMG_PATH=fastlane/build/${DMG_NAME}" >> $GITHUB_ENV
          echo "DMG_NAME=${DMG_NAME}" >> $GITHUB_ENV

      - name: Verify build artifacts
        run: |
          if [ ! -f "${{ env.DMG_PATH }}" ]; then
            echo "❌ DMG not found at ${{ env.DMG_PATH }}"
            echo "Available files in fastlane/build/:"
            ls -la fastlane/build/ || echo "Directory does not exist"
            exit 1
          fi
          echo "✅ DMG found: ${{ env.DMG_PATH }}"
          ls -la "${{ env.DMG_PATH }}"

      - name: Generate Appcast
        run: |
          # Get DMG size
          DMG_SIZE=$(stat -f%z "${{ env.DMG_PATH }}")

          # Calculate build number (major*10000 + minor*100 + patch)
          IFS='.' read -r MAJOR MINOR PATCH <<< "${{ env.VERSION }}"
          BUILD_NUMBER=$((MAJOR * 10000 + MINOR * 100 + PATCH))

          # Get current date in RFC 2822 format
          PUB_DATE=$(date -R)

          # DMG download URL
          DMG_URL="https://github.com/${{ github.repository }}/releases/download/v${{ env.VERSION }}/${{ env.DMG_NAME }}"

          # Get Sparkle signature if it exists
          SPARKLE_SIGNATURE=""
          if [ -f "fastlane/build/sparkle_signature.txt" ]; then
            SPARKLE_SIGNATURE=$(cat fastlane/build/sparkle_signature.txt)
          fi

          # Create appcast.xml in fastlane/build/ alongside other artifacts
          cat > fastlane/build/appcast.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">
            <channel>
              <title>${{ env.APP_NAME }}</title>
              <link>https://github.com/${{ github.repository }}</link>
              <description>Most recent updates for ${{ env.APP_NAME }}</description>
              <language>en</language>
              <item>
                <title>Version ${{ env.VERSION }}</title>
                <link>https://github.com/${{ github.repository }}/releases/tag/v${{ env.VERSION }}</link>
                <sparkle:version>${BUILD_NUMBER}</sparkle:version>
                <sparkle:shortVersionString>${{ env.VERSION }}</sparkle:shortVersionString>
                <pubDate>${PUB_DATE}</pubDate>
                <enclosure
                  url="${DMG_URL}"
                  sparkle:edSignature="${SPARKLE_SIGNATURE}"
                  length="${DMG_SIZE}"
                  type="application/octet-stream"/>
                <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
              </item>
            </channel>
          </rss>
          EOF

          echo "Generated appcast.xml:"
          cat fastlane/build/appcast.xml

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Upload DMG to version-specific release
          gh release upload "v${{ env.VERSION }}" \
            "${{ env.DMG_PATH }}" \
            --clobber

          # Upload appcast.xml to version-specific release
          gh release upload "v${{ env.VERSION }}" \
            "fastlane/build/appcast.xml" \
            --clobber

          # Also upload appcast.xml to 'latest' release for Sparkle auto-updates
          # This ensures SUFeedURL pointing to /releases/latest/download/appcast.xml always works
          if gh release view latest >/dev/null 2>&1; then
            gh release upload latest \
              "fastlane/build/appcast.xml" \
              --clobber
            echo "Updated appcast.xml in 'latest' release"
          else
            echo "No 'latest' release found, skipping appcast update to latest"
          fi

          echo "Release assets uploaded successfully!"
          echo "DMG: https://github.com/${{ github.repository }}/releases/download/v${{ env.VERSION }}/${{ env.DMG_NAME }}"
          echo "Appcast: https://github.com/${{ github.repository }}/releases/download/v${{ env.VERSION }}/appcast.xml"
          echo "Appcast (latest): https://github.com/${{ github.repository }}/releases/latest/download/appcast.xml"

  create-sentry-release:
    name: Create Sentry Release
    runs-on: ubuntu-latest
    needs: [build-release]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Create Sentry release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT }}
        with:
          environment: production
          version: ${{ github.event.release.tag_name }}
          finalize: true
          ignore_missing: true
